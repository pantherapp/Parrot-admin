{"ast":null,"code":"import _createForOfIteratorHelper from\"/Users/yrm/Sites/parrot/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createForOfIteratorHelper\";import _defineProperty from\"/Users/yrm/Sites/parrot/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/defineProperty\";import _regeneratorRuntime from\"/Users/yrm/Sites/parrot/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/yrm/Sites/parrot/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _toConsumableArray from\"/Users/yrm/Sites/parrot/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _objectSpread from\"/Users/yrm/Sites/parrot/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import firebase from'firebase/app';import'firebase/firestore';import'firebase/storage';import sortBy from'sort-by';import{CREATE}from'react-admin';var convertFileToBase64=function convertFileToBase64(file){return new Promise(function(resolve,reject){var reader=new FileReader();reader.readAsDataURL(file.rawFile);reader.onload=function(){return resolve(reader.result);};reader.onerror=reject;});};var addUploadFeature=function addUploadFeature(requestHandler){return function(type,resource,params){if(type==='UPDATE'){if(params.data.image&&params.data.image.length){var formerPictures=params.data.image.filter(function(p){return!(p.rawFile instanceof File);});var newPictures=params.data.image.filter(function(p){return p.rawFile instanceof File;});return Promise.all(newPictures.map(convertFileToBase64)).then(function(base64Pictures){return base64Pictures.map(function(picture64){return{src:picture64,title:\"\".concat(params.data.title)};});}).then(function(transformedNewPictures){return requestHandler(type,resource,_objectSpread(_objectSpread({},params),{},{data:_objectSpread(_objectSpread({},params.data),{},{image:[].concat(_toConsumableArray(transformedNewPictures),_toConsumableArray(formerPictures))})}));});}}// for other request types and reources, fall back to the defautl request handler\nreturn requestHandler(type,resource,params);};};var getImageSize=function getImageSize(file){return new Promise(function(resolve){var img=document.createElement('img');img.onload=function(){resolve({width:this.width,height:this.height});};img.src=file.src;});};var upload=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(fieldName,submitedData,id,resourceName,resourcePath){var file,rawFile,result,ref,snapshot,downloadURL,imageSize;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:file=submitedData[fieldName];if(file){_context.next=3;break;}return _context.abrupt(\"return\",false);case 3:file=Array.isArray(file)?file[0]:file;rawFile=file.rawFile;result={};if(!(file&&rawFile&&rawFile.name)){_context.next=32;break;}ref=firebase.storage().ref().child(\"\".concat(resourcePath,\"/\").concat(id,\"/\").concat(fieldName));_context.next=10;return ref.put(rawFile);case 10:snapshot=_context.sent;_context.next=13;return snapshot.ref.getDownloadURL();case 13:downloadURL=_context.sent;result[fieldName]=[{}];result[fieldName][0].uploadedAt=new Date();result[fieldName][0].src=downloadURL;result[fieldName][0].type=rawFile.type;result[fieldName][0].name=rawFile.name;if(!(rawFile.type.indexOf('image/')===0)){_context.next=31;break;}_context.prev=20;_context.next=23;return getImageSize(file);case 23:imageSize=_context.sent;result[fieldName][0].width=imageSize.width;result[fieldName][0].height=imageSize.height;_context.next=31;break;case 28:_context.prev=28;_context.t0=_context[\"catch\"](20);console.error(\"Failed to get image dimensions\");case 31:return _context.abrupt(\"return\",result);case 32:return _context.abrupt(\"return\",false);case 33:case\"end\":return _context.stop();}}},_callee,null,[[20,28]]);}));return function upload(_x,_x2,_x3,_x4,_x5){return _ref.apply(this,arguments);};}();var save=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(id,data,previous,resourceName,resourcePath,firebaseSaveFilter,uploadResults,isNew,timestampFieldNames){return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:if(uploadResults){uploadResults.map(function(uploadResult){return uploadResult?Object.assign(data,uploadResult):false;});}if(isNew){Object.assign(data,_defineProperty({},timestampFieldNames.createdAt,new Date()));}data=Object.assign(previous,_defineProperty({},timestampFieldNames.updatedAt,new Date()),data);if(!data.id){data.id=id;}_context2.next=6;return firebase.firestore().doc(\"\".concat(resourcePath,\"/\").concat(data.id)).set(firebaseSaveFilter(data));case 6:return _context2.abrupt(\"return\",{data:data});case 7:case\"end\":return _context2.stop();}}},_callee2);}));return function save(_x6,_x7,_x8,_x9,_x10,_x11,_x12,_x13,_x14){return _ref2.apply(this,arguments);};}();var del=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(id,resourceName,resourcePath,uploadFields){return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:if(uploadFields.length){uploadFields.map(function(fieldName){return firebase.storage().ref().child(\"\".concat(resourcePath,\"/\").concat(id,\"/\").concat(fieldName)).delete();});}_context3.next=3;return firebase.firestore().doc(\"\".concat(resourcePath,\"/\").concat(id)).delete();case 3:return _context3.abrupt(\"return\",{data:id});case 4:case\"end\":return _context3.stop();}}},_callee3);}));return function del(_x15,_x16,_x17,_x18){return _ref3.apply(this,arguments);};}();var delMany=/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(ids,resourceName,previousData){return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.next=2;return ids.map(function(id){return firebase.firestore().doc(\"\".concat(resourceName,\"/\").concat(id)).delete();});case 2:return _context4.abrupt(\"return\",{data:ids});case 3:case\"end\":return _context4.stop();}}},_callee4);}));return function delMany(_x19,_x20,_x21){return _ref4.apply(this,arguments);};}();var getItemID=function getItemID(params,type,resourceName,resourcePath,resourceData){var itemId=params.data.id||params.id||params.data.key||params.key;if(!itemId){itemId=firebase.firestore().collection(resourcePath).doc().id;}if(!itemId){throw new Error('ID is required');}if(resourceData&&resourceData[itemId]&&type===CREATE){throw new Error('ID already in use');}return itemId;};var getOne=/*#__PURE__*/function(){var _ref5=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee5(params,resourceName,resourceData){var result,data;return _regeneratorRuntime.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:if(!params.id){_context5.next=13;break;}_context5.next=3;return firebase.firestore().collection(resourceName).doc(params.id).get();case 3:result=_context5.sent;if(!result.exists){_context5.next=10;break;}data=result.data();if(data&&data.id==null){data['id']=result.id;}return _context5.abrupt(\"return\",{data:data});case 10:throw new Error('Id not found');case 11:_context5.next=14;break;case 13:throw new Error('Id not found');case 14:case\"end\":return _context5.stop();}}},_callee5);}));return function getOne(_x22,_x23,_x24){return _ref5.apply(this,arguments);};}();/**\n * params example:\n * pagination: { page: 1, perPage: 5 },\n * sort: { field: 'title', order: 'ASC' },\n * filter: { author_id: 12 }\n */var getList=/*#__PURE__*/function(){var _ref6=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee6(params,resourceName,resourceData){var values,snapshots,_iterator,_step,snapshot,_data,keys,_params$pagination,page,perPage,_start,_end,data,ids,total;return _regeneratorRuntime.wrap(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:if(!params.pagination){_context6.next=19;break;}values=[];_context6.next=4;return firebase.firestore().collection(resourceName).get();case 4:snapshots=_context6.sent;_iterator=_createForOfIteratorHelper(snapshots.docs);try{for(_iterator.s();!(_step=_iterator.n()).done;){snapshot=_step.value;_data=snapshot.data();if(_data&&_data.id==null){_data['id']=snapshot.id;}values.push(_data);}}catch(err){_iterator.e(err);}finally{_iterator.f();}if(params.filter){values=values.filter(function(item){var meetsFilters=true;for(var _i=0,_Object$keys=Object.keys(params.filter);_i<_Object$keys.length;_i++){var key=_Object$keys[_i];meetsFilters=item[key]===params.filter[key];}return meetsFilters;});}if(params.sort){values.sort(sortBy(\"\".concat(params.sort.order==='ASC'?'':'-').concat(params.sort.field)));}keys=values.map(function(i){return i.id;});_params$pagination=params.pagination,page=_params$pagination.page,perPage=_params$pagination.perPage;_start=(page-1)*perPage;_end=page*perPage;data=values?values.slice(_start,_end):[];ids=keys.slice(_start,_end)||[];total=values?values.length:0;return _context6.abrupt(\"return\",{data:data,ids:ids,total:total});case 19:throw new Error('Error processing request');case 20:case\"end\":return _context6.stop();}}},_callee6);}));return function getList(_x25,_x26,_x27){return _ref6.apply(this,arguments);};}();var getMany=/*#__PURE__*/function(){var _ref7=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee7(params,resourceName,resourceData){var data,_iterator2,_step2,id,_yield$getOne,item;return _regeneratorRuntime.wrap(function _callee7$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:data=[];/* eslint-disable no-await-in-loop */_iterator2=_createForOfIteratorHelper(params.ids);_context7.prev=2;_iterator2.s();case 4:if((_step2=_iterator2.n()).done){_context7.next=13;break;}id=_step2.value;_context7.next=8;return getOne({id:id},resourceName,resourceData);case 8:_yield$getOne=_context7.sent;item=_yield$getOne.data;data.push(item);case 11:_context7.next=4;break;case 13:_context7.next=18;break;case 15:_context7.prev=15;_context7.t0=_context7[\"catch\"](2);_iterator2.e(_context7.t0);case 18:_context7.prev=18;_iterator2.f();return _context7.finish(18);case 21:return _context7.abrupt(\"return\",{data:data});case 22:case\"end\":return _context7.stop();}}},_callee7,null,[[2,15,18,21]]);}));return function getMany(_x28,_x29,_x30){return _ref7.apply(this,arguments);};}();var getManyReference=/*#__PURE__*/function(){var _ref8=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee8(params,resourceName,resourceData){var _yield$getList,data,total;return _regeneratorRuntime.wrap(function _callee8$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:if(!params.target){_context8.next=11;break;}if(!params.filter)params.filter={};params.filter[params.target]=params.id;_context8.next=5;return getList(params,resourceName,resourceData);case 5:_yield$getList=_context8.sent;data=_yield$getList.data;total=_yield$getList.total;return _context8.abrupt(\"return\",{data:data,total:total});case 11:throw new Error('Error processing request');case 12:case\"end\":return _context8.stop();}}},_callee8);}));return function getManyReference(_x31,_x32,_x33){return _ref8.apply(this,arguments);};}();export default{upload:upload,save:save,del:del,delMany:delMany,getItemID:getItemID,getOne:getOne,getList:getList,getMany:getMany,getManyReference:getManyReference,addUploadFeature:addUploadFeature,convertFileToBase64:convertFileToBase64};","map":{"version":3,"sources":["/Users/yrm/Sites/parrot/src/lib/methods.js"],"names":["firebase","sortBy","CREATE","convertFileToBase64","file","Promise","resolve","reject","reader","FileReader","readAsDataURL","rawFile","onload","result","onerror","addUploadFeature","requestHandler","type","resource","params","data","image","length","formerPictures","filter","p","File","newPictures","all","map","then","base64Pictures","picture64","src","title","transformedNewPictures","getImageSize","img","document","createElement","width","height","upload","fieldName","submitedData","id","resourceName","resourcePath","Array","isArray","name","ref","storage","child","put","snapshot","getDownloadURL","downloadURL","uploadedAt","Date","indexOf","imageSize","console","error","save","previous","firebaseSaveFilter","uploadResults","isNew","timestampFieldNames","uploadResult","Object","assign","createdAt","updatedAt","firestore","doc","set","del","uploadFields","delete","delMany","ids","previousData","getItemID","resourceData","itemId","key","collection","Error","getOne","get","exists","getList","pagination","values","snapshots","docs","push","item","meetsFilters","keys","sort","order","field","i","page","perPage","_start","_end","slice","total","getMany","getManyReference","target"],"mappings":"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","sourcesContent":["import firebase from 'firebase/app';\nimport 'firebase/firestore';\nimport 'firebase/storage';\nimport sortBy from 'sort-by';\nimport { CREATE } from 'react-admin';\n\nconst convertFileToBase64 = file =>\n  new Promise((resolve, reject) => {\n    const reader = new FileReader();\n    reader.readAsDataURL(file.rawFile);\n\n    reader.onload = () => resolve(reader.result);\n    reader.onerror = reject;\n  });\n\nconst addUploadFeature = requestHandler => (type, resource, params) => {\n  if (type === 'UPDATE') {\n    if (params.data.image && params.data.image.length) {\n      const formerPictures = params.data.image.filter(p => !(p.rawFile instanceof File));\n      const newPictures = params.data.image.filter(p => p.rawFile instanceof File);\n\n      return Promise.all(newPictures.map(convertFileToBase64))\n        .then(base64Pictures =>\n          base64Pictures.map(picture64 => ({\n            src: picture64,\n            title: `${params.data.title}`\n          }))\n        )\n        .then(transformedNewPictures =>\n          requestHandler(type, resource, {\n            ...params,\n            data: {\n              ...params.data,\n              image: [...transformedNewPictures, ...formerPictures]\n            }\n          })\n        );\n    }\n  }\n  // for other request types and reources, fall back to the defautl request handler\n  return requestHandler(type, resource, params);\n};\n\nconst getImageSize = file => {\n  return new Promise(resolve => {\n    const img = document.createElement('img');\n    img.onload = function() {\n      resolve({\n        width: this.width,\n        height: this.height\n      });\n    };\n    img.src = file.src;\n  });\n};\n\nconst upload = async (fieldName, submitedData, id, resourceName, resourcePath) => {\n  let file = submitedData[fieldName];\n  if (!file) {\n    return false;\n  }\n  \n  file = Array.isArray(file) ? file[0] : file;\n  \n  const rawFile = file.rawFile;\n\n  const result = {};\n  if (file && rawFile && rawFile.name) {\n    const ref = firebase\n      .storage()\n      .ref()\n      .child(`${resourcePath}/${id}/${fieldName}`);\n    const snapshot = await ref.put(rawFile);\n    const downloadURL = await snapshot.ref.getDownloadURL();\n    result[fieldName] = [{}];\n    result[fieldName][0].uploadedAt = new Date();\n    result[fieldName][0].src = downloadURL;\n    result[fieldName][0].type = rawFile.type;\n    result[fieldName][0].name = rawFile.name;\n    if (rawFile.type.indexOf('image/') === 0) {\n      try {\n        const imageSize = await getImageSize(file);\n        result[fieldName][0].width = imageSize.width;\n        result[fieldName][0].height = imageSize.height;\n      } catch (e) {\n        console.error(`Failed to get image dimensions`);\n      }\n    }\n    return result;\n  }\n  return false;\n};\n\nconst save = async (\n  id,\n  data,\n  previous,\n  resourceName,\n  resourcePath,\n  firebaseSaveFilter,\n  uploadResults,\n  isNew,\n  timestampFieldNames\n) => {\n  if (uploadResults) {\n    uploadResults.map(uploadResult => (uploadResult ? Object.assign(data, uploadResult) : false));\n  }\n\n  if (isNew) {\n    Object.assign(data, { [timestampFieldNames.createdAt]: new Date() });\n  }\n\n  data = Object.assign(previous, { [timestampFieldNames.updatedAt]: new Date() }, data);\n\n  if (!data.id) {\n    data.id = id;\n  }\n\n  await firebase\n    .firestore()\n    .doc(`${resourcePath}/${data.id}`)\n    .set(firebaseSaveFilter(data));\n  return { data };\n};\n\nconst del = async (id, resourceName, resourcePath, uploadFields) => {\n  if (uploadFields.length) {\n    uploadFields.map(fieldName =>\n      firebase\n        .storage()\n        .ref()\n        .child(`${resourcePath}/${id}/${fieldName}`)\n        .delete()\n    );\n  }\n\n  await firebase\n    .firestore()\n    .doc(`${resourcePath}/${id}`)\n    .delete();\n  return { data: id };\n};\n\nconst delMany = async (ids, resourceName, previousData) => {\n  await ids.map(id =>\n    firebase\n      .firestore()\n      .doc(`${resourceName}/${id}`)\n      .delete()\n  );\n  return { data: ids };\n};\n\nconst getItemID = (params, type, resourceName, resourcePath, resourceData) => {\n  let itemId = params.data.id || params.id || params.data.key || params.key;\n  if (!itemId) {\n    itemId = firebase\n      .firestore()\n      .collection(resourcePath)\n      .doc().id;\n  }\n\n  if (!itemId) {\n    throw new Error('ID is required');\n  }\n\n  if (resourceData && resourceData[itemId] && type === CREATE) {\n    throw new Error('ID already in use');\n  }\n\n  return itemId;\n};\n\nconst getOne = async (params, resourceName, resourceData) => {\n  if (params.id) {\n    let result = await firebase\n      .firestore()\n      .collection(resourceName)\n      .doc(params.id)\n      .get();\n\n    if (result.exists) {\n      const data = result.data();\n\n      if (data && data.id == null) {\n        data['id'] = result.id;\n      }\n      return { data: data };\n    } else {\n      throw new Error('Id not found');\n    }\n  } else {\n    throw new Error('Id not found');\n  }\n};\n\n/**\n * params example:\n * pagination: { page: 1, perPage: 5 },\n * sort: { field: 'title', order: 'ASC' },\n * filter: { author_id: 12 }\n */\n\nconst getList = async (params, resourceName, resourceData) => {\n  if (params.pagination) {\n    let values = [];\n    let snapshots = await firebase\n      .firestore()\n      .collection(resourceName)\n      .get();\n\n    for (const snapshot of snapshots.docs) {\n      const data = snapshot.data();\n      if (data && data.id == null) {\n        data['id'] = snapshot.id;\n      }\n      values.push(data);\n    }\n\n    if (params.filter) {\n      values = values.filter(item => {\n        let meetsFilters = true;\n        for (const key of Object.keys(params.filter)) {\n          meetsFilters = item[key] === params.filter[key];\n        }\n        return meetsFilters;\n      });\n    }\n\n    if (params.sort) {\n      values.sort(sortBy(`${params.sort.order === 'ASC' ? '' : '-'}${params.sort.field}`));\n    }\n\n    const keys = values.map(i => i.id);\n    const { page, perPage } = params.pagination;\n    const _start = (page - 1) * perPage;\n    const _end = page * perPage;\n    const data = values ? values.slice(_start, _end) : [];\n    const ids = keys.slice(_start, _end) || [];\n    const total = values ? values.length : 0;\n    return { data, ids, total };\n  } else {\n    throw new Error('Error processing request');\n  }\n};\n\nconst getMany = async (params, resourceName, resourceData) => {\n  let data = [];\n  /* eslint-disable no-await-in-loop */\n  for (const id of params.ids) {\n    let { data: item } = await getOne({ id }, resourceName, resourceData);\n    data.push(item);\n  }\n  return { data };\n};\n\nconst getManyReference = async (params, resourceName, resourceData) => {\n  if (params.target) {\n    if (!params.filter) params.filter = {};\n    params.filter[params.target] = params.id;\n    let { data, total } = await getList(params, resourceName, resourceData);\n    return { data, total };\n  } else {\n    throw new Error('Error processing request');\n  }\n};\n\nexport default {\n  upload,\n  save,\n  del,\n  delMany,\n  getItemID,\n  getOne,\n  getList,\n  getMany,\n  getManyReference,\n  addUploadFeature,\n  convertFileToBase64\n};"]},"metadata":{},"sourceType":"module"}